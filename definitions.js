/*
 * Copyright Â© Enable Software Pty Ltd 2013 - All rights reserved
 */



function Definitions() {
    var _this = this;
    this.mapping = {"8B32783107": "AZ1N100M", "2344500405":"A4SE700E","2354500405":"A4SE700F","2604446305":"A4SH701G","2604446405":"A4SHB00G","2604446505":"A4SHC00G","2604446605":"A4SHC01G","2604686305":"A4SH701H","2604686405":"A4SHB00H","2604686505":"A4SHC00H","2654786105":"A4SH701K","2904485005":"A4SDA00P","2904495005":"A4SDA00Q","2904497105":"A4SDA01Q","2944594105":"A4RG060Q","2944596105":"A4RN1000","2954594105":"A4RG060P","3112405106":"A2ZJ201D","3112485106":"A2ZJ500I","3112485406":"A2ZJ512I","3144504006":"A2ZJ500F","3152504006":"A2ZJ500H","3152584006":"A2ZJ500M","3614446105":"A4TC101K","3614446205":"A4TC300K","3614486105":"A4TC101L","3614486205":"A4TC300L","3614486305":"A4TC400L","3614486405":"A4TC401L","3712405006":"A2ZJ500K","3712485006":"A2ZJ500L","3722047206":"E6PF101A","4212047006":"E2VG211D","4212047106":"E2VG221D","4212505106":"A8DH101D","4212585006":"A8DH100I","4212585106":"A8DH101I","4242504106":"A8DH100P","4242584106":"A8DH100F","4252187006":"E2VG212E","4252504106":"A8DH100H","4252584106":"A8DH100M","401A344206":"D0XJ002B","4C1A344007":"D2UG101B","3F12404006":"A2WC400K","3F12484006":"A2WC400L","371240A006":"A2WC50  ","3F12404106":"A2WC500K","3F12484106":"A2WC500L","3F12484206":"A2WC501L","4812403006":"A2WF100K","4812483006":"A2WF100L","4812403106":"A2WF101K","4812483106":"A2WF101L","6304504107":"AZ1H102W","7B04507007":"AZ1J500X","5104144007":"E2TB101Q","7144345007":"EP5D004L","7134347007":"EP5D700X","5312146007":"E2TB011I","4E52144007":"E2UE101J","4E52184007":"E2UE102J","3B12044206":"E2ZJ121H","5C52184007":"EZ1G107M","6c52144007":"EZ1G108N","5C22147007":"EZ1G109J","5C12187007":"EZ1G109K","3B02593006":"A2WA20  ","3B02594006":"A2WC000E","3B02594216":"A2WC011E","3B02594316":"A2WC012E","3B02594416":"A2WC013E","74A2594007":"AZ1G800L","2A04484005":"A4RI200I","2A04486005":"A4RI300I","3B04484105":"A4RI401I","2A44506005":"A4RL100J","2AA4506005":"A4RL100K","23A4500405":"A4SE700J","3B12504006":"A2WC400D","3B52503006":"A2WC400H","3B12584006":"A2WC400I","3B52583006":"A2WC400M","3B42584006":"A2WC401F","3B12504106":"A2WC410D","3B12584106":"A2WC410I","3B12584206":"A2WC411I","3B12504306":"A2WC412D","3B12584306":"A2WC412I","3B42584116":"A2WC420F","3B52583116":"A2WC420M","3B44503006":"A2ZJA00P","3BA4503006":"A2ZJA00Q","3B44503116":"A2ZJA10P","4E12504107":"A8DK100D","4EA2504007":"A8DK100E","4E42584007":"A8DK100F","4E52504007":"A8DK100H","4E12584107":"A8DK100I","4E52584007":"A8DK100M","4E42504007":"A8DK100P","7F12505007":"AE5K411R","8512506007":"AE5L500R","7142504007":"AZ1G900P","5C42584007":"AZ1G101M","5C42504007":"AZ1G101N","5C12504007":"AZ1G800V","5C04505207":"AZ1G105L","6C12506007":"AZ1G601R","7142584007":"AZ1G900O","7134345007":"EP5D202X","73343C4207":"EP5F301I","73243C7507":"EP5G601B","8424385107":"EP5I200F","4D12044006":"E2UE101L","4D12084006":"E2UE102L","4D12084106":"E2UE202L","4D12048006":"E2UG001L","4D12088006":"E2UG002L","431208A006":"E2VH100C","4312044006":"E2VH101C","4312084006":"E2VH102C","4312047106":"E2VH111C","4312087106":"E2VH112C","4312087206":"E2VH202C","7012187007":"EE5I910G","7012147007":"EE5I910H","7522167007":"EE5I910T","5112184007":"EZ1E102G","5112144007":"EZ1E102H","5112187007":"EZ1E401G","5112147007":"EZ1E401H","5112188007":"EZ1GB00G","3E12044006":"E2ZJ101G","3E12084006":"E2ZJ103G","3E12044106":"E2ZJ111G","3E12084106":"E2ZJ113G","3E12044206":"E2ZJ121G","3E12084206":"E2ZJ123G","3E12084306":"E2ZJ133G","5104584007":"A2TB100U","5104504007":"A2TB100V","6304504007":"AZ1H101W","4D12784006":"A2UG000J","4D12784206":"A2UJ000J","2E12495106":"A2ZJ500J","2E12495206":"A2ZJ700J","2E12495306":"A2ZJ710J","3D12594006":"A2ZJB10J","3D12594106":"A2ZJB11J","4312594006":"A2ZJE11J","29044A4105":"A4RG050N","29044B6005":"A4RG050R","29044A7105":"A4RG051N","29046B6005":"A4RG052N","2E44594005":"A4RM000H","2E54594105":"A4RM100G","2E44594105":"A4RM100H","2E44596105":"A4RN200H","3D44593005":"A4RN300G","3D54593005":"A4RN300I","1B04490305":"A4SD600B","1B04490405":"A4SD700B","1B04490505":"A4SD800B","1B04490605":"A4SD900B","1B04490805":"A4SDA01B","2E04494005":"A4TE001B","2E04496005":"A4TE002B","2E044A6005":"A4TE002Q","3D04594005":"A4TJ111B","3D044A4005":"A4TJ111C","3D045B4005":"A4TJ120S","4304594005":"A4TJ121B","43045A4005":"A4TJ121C","43045B4005":"A4TJ121S","3D04EA4605":"A4TJ1X00","4342592006":"A8DG300Z","4352594006":"A8DH200V","4342594006":"A8DH200Z","4D52594006":"A8DK100V","4D42594006":"A8DK100Z","7412597007":"AE5I910V","7412597207":"AE5IB00V","8112595007":"AE5K500V","8112597007":"AE5K611V","8112597107":"AE5K700V","8A12784007":"AE5L500V","5AA2784007":"AZ1G200J","5A42784107":"AZ1G201G","5A12784107":"AZ1G201I","5A42784207":"AZ1G202G","6912783007":"AZ1G202I","5AA2784207":"AZ1G202J","5A04784107":"AZ1G300F","5A04784207":"AZ1G301F","6904784007":"AZ1G500F","6902744007":"AZ1G502L","72F2784007":"AZ1G700H","7212786007":"AZ1G701I","7212786107":"AZ1G702I","7402744007":"AZ1G800F","7404784007":"AZ1G800T","7442594007":"AZ1J500G","7432744007":"AZ1J500J","8A04794007":"AZ1K000T","5A4278A107":"Z1G20000","2EA4584005":"A4RM100F","3DA4583005":"A4RM200K","1B04400405":"A4SD501A","1B04400505":"A4SD800A","1B04400605":"A4SD900A","1B44580105":"A4SE300D","1B44580405":"A4SE700D","1B54500405":"A4SE700I","1B44580505":"A4SE900D","1B54500505":"A4SE900I","1B14400305":"A4SG900C","1B14400405":"A4SGA00C","1B14400505":"A4SGC00C","1B14400605":"A4SGD10C","1B14400705":"A4SGE00C","1B14400805":"A4SGE01C","2E54504105":"A4TE001I","2E04404005":"A4TE000A","2E44584105":"A4TE001G","2E44586005":"A4TE100G","3D04403005":"A4TE200A","3D44583005":"A4TE300D","2E14446006":"A4TF300E","2E14486006":"A4TF300F","2E14446106":"A4TF400E","2E14486106":"A4TF500F","2E14446206":"A4TF510E","2E14486206":"A4TF510F","2E14486306":"A4TF520F","3E14483006":"A4TF7000","3E14444006":"A4TF800E","3E14484006":"A4TF800F","3E14486006":"A4TF810F","3A54504005":"A4TH000N","3A54584005":"A4TH000O","3D54583005":"A4TH100H","3D545B6005":"A4TH100L","4352584006":"A8DH200O","43A2584006":"A8DH200U","4312504006":"A8DH200W","4312584006":"A8DH200X","4342584006":"A8DH200Y","4312584106":"A8DH201X","4312584206":"A8DH202X","4D425A6006":"A8DK100K","4D525A6006":"A8DK100L","4D52584006":"A8DK100O","4DA2584006":"A8DK100U","4D12504006":"A8DK100W","4D12584006":"A8DK100X","4D42584006":"A8DK100Y","4D12584106":"A8DK101X","7412587007":"AE5I910L","7412587107":"AE5IA10L","7412587207":"AE5IB00L","7412587407":"AE5IB40L","8112585007":"AE5K500L","8112587007":"AE5K611L","8112587207":"AE5K800L","8A12584007":"AE5L500L","5152584007":"AZ1E400C","51A2584007":"AZ1E400E","5142584007":"AZ1E400U","5112584107":"AZ1E401A","5112504107":"AZ1E401B","6642584007":"AZ1G400U","6652784007":"AZ1G400W","66A2784007":"AZ1G400X","6642784007":"AZ1G400Y","6612784007":"AZ1G401V","7472594007":"AZ1G700K","6E12786007":"AZ1G701V","74A2584007":"AZ1G800D","7452584007":"AZ1G900C","2F04015206":"E2ZD308E","6202154007":"E2SB001K","52521A4007":"E2TB102M","4512184106":"E2VG204B","4512147106":"E2VG221B","2F12044106":"E2ZJ101B","2F12044506":"E2ZJ141B","2F120A4606":"E2ZJ173B","7C121A7407":"EE5K801W","52121A7007":"EZ1D105C","5212167107":"EZ1D201D","52221A7207":"EZ1D301A","5222167307":"EZ1D302B","52121A7307":"EZ1D302C","5212167307":"EZ1D302D","5222167407":"EZ1D303B","454A344006":"D0XJ001R","521A355007":"D2TB101P","524A344007":"D2TB201R","621A356007":"D2TC001P","4B0A368007":"D2UK001Q","3C0A383106":"D2WD200A","3C0A384206":"D2WD604A","3C0A387516":"D2WD612A","3c4a384106":"D2WD701C","2F0A367306":"D2ZU200A","3C4A354006":"D2ZZ001E","751b367207":"DE5IB00G","7522168007":"EE5I920T","5212785007":"A2TB000L","5212785107":"A2TB001L","5212527007":"A2TB002C","5204784007":"A2TB100K","4B04785007":"A2UG000K","4B12785007":"A2UG000L","4B04785207":"A2UI000K","4B12785207":"A2UI001L","4B04535107":"A2PG420A","6204504007":"A2SB000A","52125A5007":"A2TB000N","5204504007":"A2TB100A","5204584007":"A2TB100B","520450C007":"A2TB100Y","4B04585007":"A2UG000B","4B12525007":"A2UG000C","4B125A5007":"A2UG000N","4B04505107":"A2UH000A","4B04505207":"A2UI000A","4B12525207":"A2UI001C","2F12505106":"A2WC500C","2F12785106":"A2WC500N","2F12505206":"A2WC510C","2F12785206":"A2WC510N","2F12505306":"A2WC511C","2F12785306":"A2WC511N","2F12505506":"A2WC521C","2F12785506":"A2WC521N","2F12785606":"A2WC522N","3C04504006":"A2WD000A","3C04504106":"A2WD001A","3C04784106":"A2WD001B","3C04504216":"A2WD010A","3C04784216":"A2WD010B","3C04504316":"A2WD012A","3C04784316":"A2WD012B","4512503106":"A2WF200C","4512783106":"A2WF200N","2F04785006":"A2ZJ600B","2F04505106":"A2ZJ601A","2F04505206":"A2ZJ800A","2F04785206":"A2ZJC00B","2F04505406":"A2ZJD00A","2F04785306":"A2ZJD00B","2F04505506":"A2ZJD01A","2F04785506":"A2ZJD02B","5B025A4007":"AE5F300B","5B42564107":"AE5F301C","5b125a6007":"AE5F301E","5b72564107":"AE5F301H","7542564007":"AE5I500G","5212525107":"A2TB001C","52125A5107":"A2TB001N","7E42564007":"AE5M100G","455A384006":"D0XJ001M","455A344006":"D0XJ001T","4B5A384007":"D2UH001M","4B5A347007":"D2UJ001T","3C5A384106":"D2WD603H","3C5A387116":"D2WD610H","3C5A347116":"D2ZY110H","2D54544005":"A4SHA10R","4B52504107":"A2UG001G","4B52584207":"A2UG002T","4B5250A007":"A2UI000Y","4B5258A007":"A2UI000Z","3C54504106":"A2WD001G","3C54784106":"A2WD001T","3C54784206":"A2WD002T","3C54504216":"A2WD010G","3C54784216":"A2WD010T","4F54507016":"A2WD010Y","4F54787016":"A2WD010Z","3C54504316":"A2WD012G","3C54784316":"A2WD012T","2F54505006":"A2ZJ800G","2F54505106":"A2ZJC00G","2F54505206":"A2ZJD00G","2F54505406":"A2ZJD02G","5B525A4107":"AE5F301D","7502564007":"AE5I001A","62421A4007":"E2SB002L","4B12187007":"E2UE102B","4512187106":"E2VG222B","3C02057416":"E2WD500D","2F421A6106":"E2ZD508C","7532164007":"EE5I500A","75121a7307":"EE5IB20W","7c02164007":"EE5K000K","5222167007":"EZ1D105B","454A357006":"D0XJ002S","4B4A347007":"D2UJ003R","2F1A357206":"D2ZX110B","6202504007":"A2SB000Y","2F12515106":"A2WC500R","2F12515206":"A2WC510R","2F12795206":"A2WC510S","2F12515306":"A2WC511R","2F12515506":"A2WC521R","2F12795606":"A2WC522S","4512513106":"A2WF200R","4512793106":"A2WF200S","2F5A356006":"D2ZS002D","2f1a355006":"D2ZX004B","3C42164006":"E2WD200C","761b347007":"DE5F810K","821B367007":"DE5K411K","571B347007":"DZ1E401B","671B344007":"DZ1E402B","574B343107":"DZ1G001F","73243e4007":"EP5F300t"};
    this.definitionsList = [];
     new FileSystem().done(function () {
        _this.fileSystem = this;
        _this.fileSystem.mkdir("/definitions");
    });
    
}

Definitions.prototype.LoadDefinitions = function (buffer) {
    var _this = this;
    require(["external/zip/zip.min.js"], function() {
        var blob = new Blob([buffer]);
        _this.zip = new zip.fs.FS();
        zip.workerScriptsPath = "external/zip/";
        _this.zip.importBlob(blob, function () { _this.ZipLoaded() }, function () { _this.ZipError() });
    });
};


Definitions.prototype.SaveLoggerDefinitions = function (buffer) {
    this.fileSystem.save("/logger.xml", buffer).done(function() {
       console.log("Definitions.SaveLoggerDefinitions: saved logger.xml");
    });
};

Definitions.prototype.ProcessDefinition = function (elements, index) {    
    this.UpdateProgress(index);
    var _this = this;
    if (index < elements.length) {
        var element = elements[index];
        element.element.getText(
            (function (element) {
                return function (e) {
                    element.xml = e;
                    var xml = $($.parseXML(element.xml));
                    var romid = xml.find("romid");
                    if (romid.find("xmlid").text() == "32BITBASE") {
                        element.filename = "32BITBASE" + ".xml";
                    } else if (romid.find("xmlid").text() == "16BITBASE") {
                        element.filename = "16BITBASE" + ".xml";
                    } else {
                        
                        element.internalidstring = romid.find("internalidstring").text();                    
                        element.ecuid = romid.find("ecuid").text();
                        _this.mapping[element.ecuid] = element.internalidstring;
                        element.filename = element.internalidstring + ".xml";
                    }
                    _this.fileSystem.save("/definitions/" + element.filename, element.xml).done(function () {      
                        _this.ProcessDefinition(elements, ++index); 
                    }).fail(function() {
                        console.log("Failed to save definition");
                    });
                    
                };
            })(element));
    } 
};

Definitions.prototype.FindDefinitions = function(defs, element) {   
    if (element.directory) {
        for (var c in element.children) {
            defs.concat(this.FindDefinitions(defs, element.children[c]));
        }
    } else {
        defs.push({ name: element.name, element: element });
    }

    return defs;
};


Definitions.prototype.SaveDefinition = function (filename, data) {
    var deferred = $.Deferred();
    filename = this.mapping[filename] + ".xml";
    if (Options.googleDriveDefinitionsFolderId !== undefined && Options.googleDriveDefinitionsFolderId !== "") {
        new GDFileSystem().done(function() {
            this.saveParentId(Options.googleDriveDefinitionsFolderId, filename, data, true).done(function() {
                deferred.resolve();    
            }).fail(function(e) {
               deferred.reject(e);
            });
        }).fail(function(e) {
               deferred.reject(e);
        });
    } else {
        this.fileSystem.save("/definitions/" + filename, data).done(function (x) {
            deferred.resolve();
        }).fail(function(e) { 
            deferred.reject();
        });
    }
    
    return deferred.promise();
};

Definitions.prototype.GetDefinition = function (filename) {
    var _this = this;
    var deferred = $.Deferred();
    if (filename.indexOf("BITBASE") == -1) {
        filename = this.mapping[filename];
    }
    
    filename = filename + ".xml";
        
    if (Options.googleDriveDefinitionsFolderId !== undefined && Options.googleDriveDefinitionsFolderId !== "") {
        new GDFileSystem().done(function() {
            this.readParentId(Options.googleDriveDefinitionsFolderId, filename, true).done(function(x) {
              deferred.resolve(x);  
            }).fail(function(x) {
                _this.fileSystem.read("/definitions/" + filename, true).done(function (x) {
                    deferred.resolve(x);
                }).fail(function(e) { 
                    deferred.reject(e);
                });
            });
        });
    } else {
        this.fileSystem.read("/definitions/" + filename, true).done(function (x) {
            deferred.resolve(x);
        }).fail(function(e) { 
            deferred.reject(e);
        });
    }
    return deferred.promise();
};

Definitions.prototype.RomIdToObject = function(romid) {
    var result = {};

    romid.children().each(function(e) { 
        result[$(this).get(0).tagName] = $(this).text();
    });

    return result;
};

Definitions.prototype.RenderDefinitions = function() {
    var _this = this;
    var render = function() {
        RenderTemplate("#definitions-list-template", _this.definitionsList, "#definitions-list-placeholder");
    };
    this.fileSystem.list("/definitions", (function(render) { 
        return function(entry, last) {
            _this.GetDefinition(entry.name, function(data) {
                var def = $($.parseXML(data)).find("romid");
                _this.definitionsList.push(_this.RomIdToObject(def));
                if (last) {
                    render();
                }
            });
        };
    })(render));
};

Definitions.prototype.UpdateProgress = function (index) {
    var perc = parseInt((100 * index) / this.count, 10);
    var container = $(".load-definitions-progress:first");
    if (!container.is(":visible")) {
        $("#load-definitions-progress-info").html("Loading...");
        container.show();        
    }
    $("#load-definitions-progress").width(perc + "%");
    if (perc == 100) {
        container.hide();
        $("#load-definitions-progress-info").html("Loaded " + this.count + " definitions.");
    }
};

Definitions.prototype.ZipLoaded = function () {
    this.defs = Definitions.prototype.FindDefinitions([], this.zip.root);
    this.count = this.defs.length;    
    this.ProcessDefinition(this.defs, 0);
};

Definitions.prototype.ZipError = function() {
    console.log("ZipError " + this);
};

$(document).ready(function () {
    _global_definitions = new Definitions();

    $("#load-definitions-button").click(function (e) {
        e.preventDefault();
        $("#load-definitions").click();
    });

    $("#load-definitions").on("change", function () {
        var f = $(this).get(0).files[0];
        var reader = new FileReader();
        if (f.name.indexOf(".xml") != -1) {
            reader.onload = function (e) {
                _global_definitions.count = 1;    
                _global_definitions.ProcessDefinition([{ name: f.name, element: { getText: function(a) { a(e.target.result);} } }], 0);
            };
            reader.readAsText(f);
        } else {
        reader.onload = function (e) {
                _global_definitions.LoadDefinitions(e.target.result);
            };
            reader.readAsArrayBuffer(f);
        }
    });
    
     $("#load-logger-definitions-button").click(function (e) {
        e.preventDefault();
        $("#load-logger-definitions").click();
    });

    $("#load-logger-definitions").on("change", function () {
        var f = $(this).get(0).files[0];
        var reader = new FileReader();
        reader.onload = function (e) {
            _global_definitions.SaveLoggerDefinitions(e.target.result);
        };
        reader.readAsArrayBuffer(f);
    });
});

